<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>图书商城</title>
  <!-- 引入 Bootstrap CSS -->
  <link href="/static/css/bootstrap.min.css" rel="stylesheet">
  <style>
    p {
      padding: 0;
      margin: 0;
    }

    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }

    .b-example-divider {
      height: 3rem;
      background-color: rgba(0, 0, 0, .1);
      border: solid rgba(0, 0, 0, .15);
      border-width: 1px 0;
      box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
    }

    .b-example-vr {
      flex-shrink: 0;
      width: 1.5rem;
      height: 100vh;
    }

    .bi {
      vertical-align: -.125em;
      fill: currentColor;
    }

    .nav-scroller {
      position: relative;
      z-index: 2;
      height: 2.75rem;
      overflow-y: hidden;
    }

    .nav-scroller .nav {
      display: flex;
      flex-wrap: nowrap;
      padding-bottom: 1rem;
      margin-top: -1px;
      overflow-x: auto;
      text-align: center;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
    }
  </style>

</head>
<body>

<div class="container mt-5">
  <div
      class="toast position-absolute align-items-center text-white bg-info border-0 top-0 start-50 translate-middle-x"
      role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">

      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
              aria-label="Close"></button>
    </div>
  </div>
  <div>
    <h1 class="mb-4">图书商城</h1>
    <div style="display: flex;flex-direction: row; justify-content: end">
      <span>欢迎高贵的<span class="username"></span>贵客光临</span>
      <span style="width: 10px"></span>
      <a href="/pages/user/index.html">首页</a>
      <span style="width: 10px"></span>
      <a href="/pages/manage/index.html">去管理图书</a>
      <span style="width: 10px"></span>
      <a href="/pages/cart/index.html">购物车</a>
    </div>
  </div>
  <div class="totalCount" style="display: flex; justify-content: end; padding-bottom: 10px; padding-top: 10px;">

  </div>
  <div class="row bookWrap">
  </div>
  <!-- 分页 -->
  <nav aria-label="Page navigation example">
    <ul class="pagination justify-content-center">
    </ul>
  </nav>
</div>

<!-- 引入 Bootstrap JS 和依赖 -->
<!--<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>-->
<script src="/static/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/request.js"></script>
<script>
  // /getBooks
  getBooks(1, 10)

  async function getBooks(page, limit) {
    let res = await request("/getBooks", {
      page: page,
      limit: limit
    }, "post", "fetch")
    if (res.status === 200) {
      if (res.data.books.length > 0) {
        createBookList(res.data.books)
        createPagination(res.data.totalPages)
      }
    }
    // console.log("res-----", res)
  }

  function createBookList(books) {
    const bookWrap = document.querySelector(".bookWrap")
    bookWrap.innerHTML = ""
    const fragment = document.createDocumentFragment()
    books.map(item => {
      let div = document.createElement("div")
      div.className = "col-md-2 mb-2"
      div.innerHTML = `
       <div class="card">
        <img src="/${item.imgPath}" class="card-img-top" alt="Book 1">
        <div class="card-body" style="padding: 0 20px">
          <h5 class="card-title">${item.title}</h5>
          <p class="card-text">${item.author}</p>
          <p class="card-text">¥ ${item.price}</p>
          <button class="btn btn-primary" onclick="addCart(${item.id}, ${item.price}, '${item.title}')">购买</button>
        </div>
      </div>
    `
      fragment.appendChild(div)
    })


    bookWrap.appendChild(fragment)
  }

  function createPagination(total) {
    const pagination = document.querySelector(".pagination")
    pagination.innerHTML = ""
    const fragment = document.createDocumentFragment()
    let pre = document.createElement("li")
    for (let i = 0; i < total; i++) {
      let li = document.createElement("li")
      li.className = "page-item"
      li.innerHTML = `<button className="page-link btn btn-primary" href="javascript:;">${i + 1}</button>`
      fragment.appendChild(li)
    }
    pagination.appendChild(fragment)
  }

  function PaginationClick() {
    const pagination = document.querySelector(".pagination")
    pagination.addEventListener("click", (event) => {
      event.preventDefault()
      // console.log("event", event.target.innerHTML)
      getBooks(event.target.innerHTML * 1, 10)
    })
  }

  PaginationClick();

  function getUserName() {
    let user = JSON.parse(sessionStorage.getItem("user"));
    // console.log("user", JSON.parse(user));
    document.querySelector(".username").innerHTML = `<span style="color: orangered; font-size: 20px; font-weight: bold">${user.userName}</span>`
  }

  getUserName();

  async function getCartTotal() {
    let user = JSON.parse(sessionStorage.getItem("user"));
    const totalCount = document.querySelector(".totalCount")
    let res = await request("/getCart", {
      ...user
    }, "post", "fetch")
    if (res.status === 200) {
      if (!!res.data && res.data.items.length > 0) {
        // createBookList(res.data.books)
        // createPagination(res.data.totalPages)
        totalCount.innerHTML = ` 购物车中有${res.data.items.length}件商品`
      } else {
        totalCount.innerHTML = ` 购物车中有0件商品`
      }

      // console.log('res', res)
    }
  }

  getCartTotal()

  // getCartTotal()

  async function addCart(id, price, title) {
    // console.log('12121212121212', price)
    let user = JSON.parse(sessionStorage.getItem("user"));
    let res = await request("/addCart", {
      userId: user.id + '',
      bookId: id + '',
      price: price + ''
    }, "post", "fetch")

    if (res.status === 200) {
      if (document.querySelector(".toast").classList.contains("hide")) {
        document.querySelector(".toast").classList.add("show")
        document.querySelector(".toast-body").innerHTML = `刚刚将<span style="color:indianred">${title}</span>加入购物车`
        setTimeout(() => {
          document.querySelector(".toast").classList.remove("show")
        }, 2000)
      } else {
        document.querySelector(".toast").classList.add("show")
        document.querySelector(".toast-body").innerHTML = `刚刚将<span style="color:indianred">${title}</span>加入购物车`
        setTimeout(() => {
          document.querySelector(".toast").classList.remove("show")
        }, 2000)
      }
      await getCartTotal()
    }

  }
</script>
</body>
</html>
