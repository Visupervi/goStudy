<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>购物车管理</title>
  <!-- Bootstrap CSS -->
  <link href="/static/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
  <h1 class="text-center">购物车管理</h1>
  <div>
    <a href="/pages/books/index.html">继续购物</a>
  </div>
  <!-- 购物车 -->
  <div class="row mt-4">
    <div class="col-md-12">
      <h2>购物车</h2>
      <ul class="list-group mb-3" id="cart-items">
        <!-- 可以添加更多购物车项 -->
      </ul>
      <h3 class="text-right">总量：<span id="total-count"></span> <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>总计:
        ¥<span id="total-amount"></span></h3>
      <button class="btn btn-success btn-block" id="checkout-btn">结账</button>
      <button class="btn btn-danger btn-block" id="clear-btn" onclick="clearCart()">清空购物车</button>
    </div>
  </div>


  <!-- Modal -->
  <div class="modal fade cartModel" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">提示</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body row mb-6">
          是否清空购物车？
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary save-btn" onclick="clearHandle()">确定</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade itemModel" tabindex="-1" aria-labelledby="modalLabelItem" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalLabelItem">提示</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body row mb-12 itemModel-body">

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary save-btn" onclick="deleteItemHandle()">确定</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Bootstrap JS and dependencies -->
<!--<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>-->
<script src="/static/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/request.js"></script>

<!-- 自定义脚本 -->
<script>
  const myModal = new bootstrap.Modal(document.querySelector(".cartModel"), {
    keyboard: false
  })
  const itemModal = new bootstrap.Modal(document.querySelector(".itemModel"), {
    keyboard: false
  })

  async function getCartTotal() {
    let user = JSON.parse(sessionStorage.getItem("user"));
    const cartItems = document.querySelector("#cart-items")
    const totalAmount = document.querySelector("#total-amount")
    const totalCount = document.querySelector("#total-count")
    let res = await request("/getCart", {
      ...user
    }, "post", "fetch")
    if (res.status === 200) {
      let str = ``
      if (!!res.data && !!res.data.items && res.data.items.length > 0) {
        this.cartId = res.data.cartId
        this.userId = res.data.userId
        // createBookList(res.data.books)
        // createPagination(res.data.totalPages)
        // totalCount.innerHTML = ` 购物车中有${res.data.items.length}件商品`
        res.data.items.map(item => {
          str += `<li class="list-group-item d-flex justify-content-between align-items-center">
          <div class="cart-item">
            <span class="item-name">商品: <span class="name">${item.book.title}</span></span>
            <span class="item-price" style="margin-left: 100px">价格: <span class="price">¥${item.book.price}</span></span>
          </div>
          <div style="display: flex; flex-direction: row; width: 300px; align-items: center">
            <p style="width: 100px; margin-bottom: 0px">数量: </p>
            <input onchange="changeHandle(event, ${item.id}, '${item.book.title}')" type="number" class="form-control quantity count" value=${item.count} min="0" data-price="10.00">
          </div>
          <button class="btn btn-danger btn-sm remove-item" data-price="10.00" onclick="deleteItems(${item.id},'${item.book.title}')">移除</button>
        </li>`
        })
        totalAmount.innerHTML = `${res.data.totalAmount}`
        totalCount.innerHTML = `${res.data.totalCount}`

      } else {
        // totalCount.innerHTML = ` 购物车中有0件商品`
        str = `<p>您还没有商品添加到购物车  <a href="/pages/books/index.html">去购物</a></p>`
        totalAmount.innerHTML = '0'
        totalCount.innerHTML = `0`
      }

      cartItems.innerHTML = str

      // console.log('res', res)
    }
  }

  getCartTotal()

  // 清空购物车
  async function clearCart() {
    myModal.show()
  }

  async function clearHandle() {
    myModal.hide()
    let res = await request("/clearCart", {
      cartId: this.cartId,
      userId: this.userId + ''
    }, "post", "fetch")
    // console.log('res', res)
    if (res.status === 200) {
      await getCartTotal()
    }
  }

  async function deleteItems(id, title) {
    itemModal.show()
    this.id = id;
    document.querySelector(".itemModel-body").innerHTML = `是否删除《${title}》这本书？`

  }

  async function deleteItemHandle() {
    let user = JSON.parse(sessionStorage.getItem("user"));
    itemModal.hide()
    let res = await request("/deleteCartItem", {
      id: this.id.toString(),
    }, "post", "fetch")
    // console.log('res', res)
    if (res.status === 200) {
      await getCartTotal()
    }
  }

  async function changeHandle(e, id, title) {
    let bookCount = e.target.value;
    if (bookCount * 1 === 0) {
      this.id = id;
      // 若是0就删除
      await deleteItems(this.id, title)
      // await deleteItemHandle()
      return
    }

    let res = await request("/updateCartItem", {
      id: id.toString(),
      bookCount
    }, "post", "fetch")

    if (res.status === 200) {
      await getCartTotal()
    }

    // console.log("changechange", res)
  }
  function checkout(){
    document.querySelector("#checkout-btn").addEventListener("click", async ()=>{
      console.log("去结账");
      // 只有存在购物车才可以去结账
      if (this.cartId) {
        let res = await request("/checkout", {
          // id: id.toString(),
          // bookCount
          cartId: this.cartId,
          userId: this.userId + ''
        }, "post", "fetch")
        // console.log("res", res)
        if (res.status === 200) {
          window.location = `/pages/cart/checkout.html?orderId=${res.data.id}`
        }
      } else {
        alert("你还没购买任何商品，请先去浏览商品")
      }

    })
  }

  checkout()

  // function getUserName() {
  //   let user = JSON.parse(sessionStorage.getItem("user"));
  //   // console.log("user", JSON.parse(user));
  //   document.querySelector(".username").innerHTML = `<span style="color: orangered; font-size: 20px; font-weight: bold">${user.userName}</span>`
  // }
  //
  // getUserName();
</script>
</body>
</html>
